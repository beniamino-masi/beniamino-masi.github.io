<!DOCTYPE html>
<html lang="it" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore Elettorale | Dr. Beniamino Masi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        academic: {
                            50: '#f4f6f8',
                            100: '#e3e8ee',
                            600: '#003B70', // Pisa Blue
                            900: '#1a202c',
                            'success': '#10b981',
                            'danger': '#ef4444',
                            'apparent': '#8b5cf6'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .hemicycle-dot { transition: all 0.3s ease; }
        .hemicycle-dot:hover { r: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); z-index: 100; cursor: help; }
        
        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #003B70; }
        input:checked + .slider:before { transform: translateX(16px); }
    </style>
</head>
<body class="bg-academic-50 text-slate-700 antialiased leading-relaxed">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
            <a href="index.html" class="text-sm font-medium text-slate-500 hover:text-academic-600 flex items-center transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Back to Portfolio
            </a>
            <span class="font-serif font-bold text-slate-800">Beniamino Masi</span>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-6 py-12">
        
        <header class="text-center mb-12">
            <h1 class="font-serif text-3xl md:text-4xl font-bold text-slate-900 mb-4">Municipal Election Simulator</h1>
            <p class="text-slate-600 max-w-2xl mx-auto">
                A tool to simulate seat distribution in Italian municipal elections (>15k inhabitants). Configure coalitions, including "votes only for mayor" to accurately simulate ballot scenarios.
            </p>
        </header>

        <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-6 md:p-8 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end mb-8">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Input Mode</label>
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button id="modeVotes" onclick="setInputMode('votes')" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-white bg-academic-600 shadow-sm">
                            Votes
                        </button>
                        <button id="modePercent" onclick="setInputMode('percent')" class="flex-1 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all">
                            %
                        </button>
                    </div>
                </div>

                <div id="totalVotesContainer">
                    <label class="block text-xs font-bold text-academic-600 uppercase tracking-wider mb-2">Total Valid Voters</label>
                    <input type="number" id="estimatedTotalVotes" value="40211" oninput="recalcLiveTotals()" 
                           class="w-full px-3 py-2 border border-academic-600 rounded-lg text-slate-900 focus:outline-none focus:ring-1 focus:ring-academic-600 font-semibold bg-blue-50">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Council Seats</label>
                    <input type="number" id="totalSeats" value="32" 
                           class="w-full px-3 py-2 border border-slate-200 rounded-lg text-slate-900 focus:border-academic-600 focus:outline-none focus:ring-1 focus:ring-academic-600 transition-colors">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">List Threshold (%)</label>
                    <input type="number" id="threshold" value="3" step="0.1" 
                           class="w-full px-3 py-2 border border-slate-200 rounded-lg text-slate-900 focus:border-academic-600 focus:outline-none focus:ring-1 focus:ring-academic-600 transition-colors">
                </div>
            </div>

            <div class="flex flex-wrap gap-3 pt-6 border-t border-slate-100">
                <button onclick="openSaveModal()" class="flex items-center px-3 py-1.5 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded hover:bg-slate-50 transition-colors">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Save
                </button>
                <button onclick="openLoadModal()" class="flex items-center px-3 py-1.5 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded hover:bg-slate-50 transition-colors">
                    <i data-lucide="folder-open" class="w-4 h-4 mr-2"></i> Load
                </button>
                <div class="flex-grow"></div>
                <button onclick="loadScenario('Pisa2023')" class="flex items-center px-3 py-1.5 text-sm font-medium text-academic-600 bg-blue-50 border border-blue-100 rounded hover:bg-blue-100 transition-colors">
                    <i data-lucide="bar-chart-2" class="w-4 h-4 mr-2"></i> Load Pisa 2023 Results
                </button>
                <button onclick="resetData()" class="flex items-center px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-red-600 transition-colors">
                    Reset
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-6">
            <h3 class="font-serif text-xl text-slate-900">Coalitions & Lists</h3>
            <button onclick="addCoalition()" class="flex items-center px-4 py-2 bg-academic-600 text-white rounded-lg hover:bg-academic-900 transition-colors shadow-sm text-sm font-medium">
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Coalition
            </button>
        </div>

        <div id="coalitionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12"></div>

        <button class="w-full py-4 bg-academic-600 text-white text-lg font-serif font-bold rounded-lg shadow-md hover:bg-academic-900 hover:shadow-lg transition-all transform hover:-translate-y-0.5 mb-12 flex items-center justify-center" onclick="calculateResults()">
            <i data-lucide="calculator" class="w-6 h-6 mr-3"></i> Calculate Distribution
        </button>

        <div id="results" class="hidden animate-fade-in bg-white rounded-xl border border-slate-200 p-8 shadow-sm">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                <h2 class="font-serif text-3xl text-slate-900">Results</h2>
                <button onclick="copyToClipboard()" class="flex items-center px-3 py-1.5 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded hover:bg-slate-50 transition-colors">
                    <i data-lucide="clipboard" class="w-4 h-4 mr-2"></i> Copy Report
                </button>
            </div>

            <p id="resultsSummary" class="text-center font-mono text-sm text-slate-500 mb-8"></p>

            <div class="bg-slate-50 rounded-xl border border-slate-200 p-8 mb-8 shadow-inner flex justify-center overflow-x-auto">
                <svg id="hemicycleSvg" width="600" height="260" viewBox="0 0 600 260" class="max-w-full"></svg>
            </div>

            <div id="resultsDetails" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>

    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/50 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 transform transition-all scale-100 border border-slate-200">
            <h3 id="modalTitle" class="font-serif text-xl font-bold text-slate-900 mb-4">Title</h3>
            <div id="modalContent" class="mb-6 text-slate-600"></div>
            <div class="flex justify-end gap-3" id="modalActions">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">Close</button>
            </div>
        </div>
    </div>

<script>
    let coalitions = [];
    let inputMode = 'votes'; 
    let lastCalculationResult = null; 
    let highlightedPartyName = null; 
    let textReport = "";
    const STORAGE_KEY = 'sim_election_saves_v1';

    function init() {
        lucide.createIcons();
        resetData();
    }

    function openModal(title, contentHtml, actionsHtml = null) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalContent').innerHTML = contentHtml;
        const actionsContainer = document.getElementById('modalActions');
        if (actionsHtml) {
            actionsContainer.innerHTML = actionsHtml;
        } else {
            actionsContainer.innerHTML = '<button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">Close</button>';
        }
        document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.add('hidden');
    }

    function getSaves() {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : {};
    }

    function openSaveModal() {
        const html = `
            <label class="block text-sm font-medium text-slate-700 mb-2">Scenario Name</label>
            <input type="text" id="saveNameInput" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-academic-600" placeholder="e.g. My Simulation 1">
        `;
        const actions = `
            <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Cancel</button>
            <button onclick="performSave()" class="px-4 py-2 text-sm font-medium text-white bg-academic-600 hover:bg-academic-900 rounded-lg shadow-sm">Save</button>
        `;
        openModal('Save Simulation', html, actions);
        setTimeout(() => document.getElementById('saveNameInput').focus(), 50);
    }

    function performSave() {
        const name = document.getElementById('saveNameInput').value.trim();
        if (!name) return alert("Please enter a name.");
        
        const saves = getSaves();
        const data = { 
            coalitions, 
            inputMode, 
            totalSeats: document.getElementById('totalSeats').value, 
            threshold: document.getElementById('threshold').value, 
            estimatedTotal: document.getElementById('estimatedTotalVotes').value,
            timestamp: Date.now()
        };
        
        saves[name] = data;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saves));
        closeModal();
        alert(`Saved "${name}" successfully.`);
    }

    function openLoadModal() {
        const saves = getSaves();
        const names = Object.keys(saves).sort((a,b) => saves[b].timestamp - saves[a].timestamp); 
        
        if (names.length === 0) {
            openModal('Load Simulation', '<p class="text-center py-4 text-slate-500 italic">No saved simulations found.</p>');
            return;
        }

        let html = '<div class="space-y-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar">';
        names.forEach(name => {
            const date = new Date(saves[name].timestamp).toLocaleDateString();
            html += `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded border border-slate-100 hover:border-academic-600 hover:bg-white transition-colors group">
                    <div onclick="performLoad('${name.replace(/'/g, "\\'")}')" class="cursor-pointer flex-1">
                        <div class="font-bold text-slate-800 text-sm group-hover:text-academic-600">${name}</div>
                        <div class="text-xs text-slate-400">${date}</div>
                    </div>
                    <button onclick="performDelete('${name.replace(/'/g, "\\'")}')" class="ml-3 p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" title="Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        });
        html += '</div>';
        
        openModal('Load Simulation', html);
        lucide.createIcons();
    }

    function performLoad(name) {
        const saves = getSaves();
        const d = saves[name];
        if (!d) return alert("Error loading save.");
        
        coalitions = d.coalitions;
        inputMode = d.inputMode || 'votes';
        document.getElementById('totalSeats').value = d.totalSeats;
        document.getElementById('threshold').value = d.threshold;
        document.getElementById('estimatedTotalVotes').value = d.estimatedTotal;
        
        setInputMode(inputMode);
        closeModal();
        recalcLiveTotals(); 
    }

    function performDelete(name) {
        if (!confirm(`Delete "${name}"?`)) return;
        const saves = getSaves();
        delete saves[name];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saves));
        closeModal();
        openLoadModal(); 
    }

    function setInputMode(mode) {
        inputMode = mode;
        const btnVotes = document.getElementById('modeVotes');
        const btnPercent = document.getElementById('modePercent');
        
        if (mode === 'votes') {
            btnVotes.className = "flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-white bg-academic-600 shadow-sm";
            btnPercent.className = "flex-1 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all";
        } else {
            btnPercent.className = "flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-white bg-academic-600 shadow-sm";
            btnVotes.className = "flex-1 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all";
        }
        renderCoalitions();
    }

    function resetData() {
        coalitions = [{ id: 1, name: "Coalizione A", isWinner: true, isApparented: false, mayorOnlyVotes: 0, parties: [{ name: "Lista 1", value: 0 }] }];
        highlightedPartyName = null;
        renderCoalitions();
        document.getElementById('results').style.display = 'none';
    }

    function renderCoalitions() {
        const container = document.getElementById('coalitionsContainer');
        container.innerHTML = '';
        const placeholderTxt = inputMode === 'percent' ? '%' : 'Votes';
        const stepValue = inputMode === 'percent' ? '0.1' : '1';

        coalitions.forEach((col, cIndex) => {
            let partiesHtml = '';
            col.parties.forEach((party, pIndex) => {
                let val = party.value > 0 ? party.value : '';
                partiesHtml += `
                    <div class="flex items-center gap-2 mb-3">
                        <input type="text" placeholder="Party Name" value="${party.name}" onchange="updateParty(${cIndex}, ${pIndex}, 'name', this.value)" 
                            class="flex-1 min-w-0 px-3 py-2 text-sm border border-slate-200 rounded bg-slate-50 focus:bg-white focus:border-academic-600 focus:outline-none transition-colors">
                        <input type="number" placeholder="${placeholderTxt}" value="${val}" step="${stepValue}" oninput="updatePartyValue(${cIndex}, ${pIndex}, this.value)" 
                            class="w-20 px-3 py-2 text-sm border border-slate-200 rounded bg-slate-50 focus:bg-white focus:border-academic-600 focus:outline-none transition-colors text-right font-mono">
                        <span id="mirror-party-${cIndex}-${pIndex}" class="text-xs text-slate-400 font-mono w-16 text-right shrink-0 truncate"></span>
                        <button onclick="removeParty(${cIndex}, ${pIndex})" class="flex-shrink-0 p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" title="Remove List">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            });

            let borderClass = 'border-slate-200';
            let bgClass = 'bg-white';
            let statusBadge = '';
            
            if(col.isWinner) {
                borderClass = 'border-academic-success';
                bgClass = 'bg-green-50/30';
                statusBadge = `<span class="absolute top-4 right-4 text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded">WINNER</span>`;
            } else if(col.isApparented) {
                borderClass = 'border-academic-apparent';
                bgClass = 'bg-purple-50/30';
                statusBadge = `<span class="absolute top-4 right-4 text-xs font-bold text-purple-700 bg-purple-100 px-2 py-1 rounded">ALLIED</span>`;
            }

            let winnerControl = '';
            if(col.isWinner) {
                winnerControl = `<label class="flex items-center text-sm font-bold text-green-700"><input type="radio" checked disabled class="mr-2 accent-academic-success"> Elected Mayor</label>`;
            } else {
                winnerControl = `
                    <div class="flex justify-between items-center w-full">
                        <label class="flex items-center text-sm text-slate-500 hover:text-slate-800 cursor-pointer">
                            <input type="radio" name="winner" onclick="setWinner(${cIndex})" class="mr-2 accent-academic-600"> Set as Winner
                        </label>
                        <label class="flex items-center text-sm text-purple-600 hover:text-purple-800 cursor-pointer font-medium">
                            <input type="checkbox" ${col.isApparented ? 'checked' : ''} onchange="setApparented(${cIndex}, this.checked)" class="mr-2 accent-academic-apparent"> Alliance (App.)
                        </label>
                    </div>
                `;
            }

            let mayorOnlyVal = col.mayorOnlyVotes > 0 ? col.mayorOnlyVotes : '';
            
            const html = `
                <div class="relative p-6 rounded-lg shadow-sm transition-all ${bgClass} border ${borderClass} border-t-4">
                    ${statusBadge}
                    
                    <div class="mb-4 pr-16">
                        <input type="text" value="${col.name}" onchange="updateCoalitionName(${cIndex}, this.value)" 
                            class="w-full font-serif font-bold text-lg text-slate-800 bg-transparent border-b border-dashed border-slate-300 focus:border-academic-600 focus:outline-none pb-1 placeholder-slate-400">
                        <div id="live-total-${cIndex}" class="text-xs font-mono text-academic-600 mt-1">Candidate Total: 0</div>
                    </div>

                    <div class="mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Votes Only for Mayor</label>
                            <div class="flex items-center">
                                <input type="number" placeholder="${placeholderTxt}" value="${mayorOnlyVal}" step="${stepValue}" oninput="updateMayorOnlyVotes(${cIndex}, this.value)" 
                                    class="w-24 px-2 py-1 text-sm border border-slate-200 rounded focus:bg-white focus:border-academic-600 focus:outline-none transition-colors text-right font-mono bg-white">
                                <span id="mirror-mayor-${cIndex}" class="text-xs text-slate-400 font-mono w-16 text-right shrink-0 truncate ml-2"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        ${partiesHtml}
                    </div>

                    <button onclick="addParty(${cIndex})" class="w-full py-2 text-xs font-medium text-academic-600 bg-blue-50 hover:bg-blue-100 rounded border border-blue-100 mb-4 transition-colors dashed-border">
                        + Add List
                    </button>
                    
                    <div class="pt-4 border-t border-slate-100 flex flex-wrap gap-2">
                        ${winnerControl}
                    </div>
                    
                    <button onclick="removeCoalition(${cIndex})" class="text-xs text-red-400 hover:text-red-600 hover:underline mt-4 w-full text-right block">
                        Delete Coalition
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
        
        lucide.createIcons();
        recalcLiveTotals();
    }

    function renderResults(results, totalVotes, threshold) {
        document.getElementById('resultsSummary').innerHTML = `Base (Valid Candidates): ${totalVotes.toLocaleString()} votes ‚Ä¢ List Threshold: ${Math.floor(threshold)}`;
        const container = document.getElementById('resultsDetails');
        container.innerHTML = '';
        
        results.forEach(res => {
            let detailsHtml = '';
            
            if(res.mayorSeat) {
                detailsHtml += `
                    <div class="flex items-center p-3 mb-2 bg-slate-50 border border-slate-200 rounded text-slate-700 text-sm">
                        <span class="mr-2 text-lg">üë§</span> <strong>1 Mayor Seat (Candidate)</strong>
                    </div>`;
            }

            res.details.sort((a,b) => b.votes - a.votes);
            res.details.forEach(party => {
                let perc = totalVotes > 0 ? ((party.votes / totalVotes) * 100).toFixed(2) : 0;
                
                let seatBadge = party.seats > 0 
                    ? `<span class="ml-auto px-2 py-0.5 text-xs font-bold text-white bg-slate-700 rounded-full shrink-0">${party.seats} Seats</span>` 
                    : `<span class="ml-auto px-2 py-0.5 text-xs font-medium text-slate-400 bg-slate-100 rounded-full shrink-0">0</span>`;
                
                if(res.isWinner && party.seats > 0) seatBadge = `<span class="ml-auto px-2 py-0.5 text-xs font-bold text-white bg-academic-success rounded-full shrink-0">${party.seats} Seats</span>`;
                if(res.isApparented && party.seats > 0) seatBadge = `<span class="ml-auto px-2 py-0.5 text-xs font-bold text-white bg-academic-apparent rounded-full shrink-0">${party.seats} Seats</span>`;

                let gapBadge = (party.gap !== null && party.votes >= threshold) ? 
                    `<div class="w-full mt-1 text-[10px] text-amber-600 bg-amber-50 px-2 py-0.5 rounded border border-amber-100 text-center">Need ${party.gap} votes for +1 seat</div>` : '';
                
                let underThreshold = party.votes < threshold 
                    ? `<span class="text-red-500 font-bold ml-1 text-xs">(Below threshold)</span>` : '';

                let toggleHtml = '';
                if(party.seats > 0) {
                    let isChecked = (highlightedPartyName === party.name) ? 'checked' : '';
                    toggleHtml = `
                        <div class="flex items-center ml-3 pl-3 border-l border-slate-100">
                            <label class="toggle-switch transform scale-75 origin-right">
                                <input type="checkbox" value="${party.name}" ${isChecked} onclick="setHighlight('${party.name}')">
                                <span class="slider"></span>
                            </label>
                        </div>`;
                }

                detailsHtml += `
                    <div class="flex flex-col p-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="min-w-0">
                                <div class="font-bold text-slate-800 text-sm truncate" title="${party.name}">${party.name}</div>
                                <div class="text-xs text-slate-500 font-mono mt-0.5">
                                    ${party.votes.toLocaleString()} (${perc}%) ${underThreshold}
                                </div>
                            </div>
                            <div class="flex items-center pl-2">
                                ${seatBadge} ${toggleHtml}
                            </div>
                        </div>
                        ${gapBadge}
                    </div>`;
            });

            let headerColor = 'text-slate-700';
            let cardBorder = 'border-l-4 border-slate-300';
            let icon = '';
            
            if(res.isWinner) {
                headerColor = 'text-green-700';
                cardBorder = 'border-l-4 border-academic-success';
                icon = 'üèÜ';
            } else if(res.isApparented) {
                headerColor = 'text-purple-700';
                cardBorder = 'border-l-4 border-academic-apparent';
                icon = 'ü§ù';
            }

            container.innerHTML += `
                <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden ${cardBorder}">
                    <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="font-serif font-bold text-md ${headerColor} truncate pr-2">${res.name} ${icon}</h3>
                        <span class="font-mono font-bold text-lg text-slate-800 shrink-0">${res.seatsTotal}</span>
                    </div>
                    <div class="px-3 py-2 bg-slate-50 border-b border-slate-100 flex justify-between text-xs text-slate-500">
                        <span>Lists: ${res.listVotes.toLocaleString()}</span>
                        <span>Mayor Only: ${res.mayorOnlyVotes.toLocaleString()}</span>
                        <strong>Total: ${res.totalVotes.toLocaleString()}</strong>
                    </div>
                    <div class="px-1 py-1">
                        ${detailsHtml}
                    </div>
                </div>`;
        });
        
        const resultsEl = document.getElementById('results');
        resultsEl.classList.remove('hidden');
        resultsEl.style.display = 'block'; 
        resultsEl.scrollIntoView({behavior: 'smooth'});
    }

    function recalcLiveTotals() {
        let grandTotalCandidate = 0;
        let isPercent = (inputMode === 'percent');
        
        const estimatedTotalInput = document.getElementById('estimatedTotalVotes').value;
        const estimatedTotal = parseInt(estimatedTotalInput) || 0;

        coalitions.forEach((col, cIndex) => {
            let listSum = 0;
            col.parties.forEach((p, pIndex) => { 
                let val = Number(p.value);
                listSum += val; 
                
                let mirrorSpan = document.getElementById(`mirror-party-${cIndex}-${pIndex}`);
                if(mirrorSpan && estimatedTotal > 0) {
                    if(isPercent) {
                        let v = Math.round((val / 100) * estimatedTotal);
                        mirrorSpan.innerText = `(${v.toLocaleString()})`;
                    } else {
                        let pct = (val / estimatedTotal) * 100;
                        mirrorSpan.innerText = `(${pct.toFixed(1)}%)`;
                    }
                } else if(mirrorSpan) {
                    mirrorSpan.innerText = '';
                }
            });
            
            // In percent mode, mayorOnlyVotes is treated as %. In votes mode, as votes.
            let mayorOnly = Number(col.mayorOnlyVotes) || 0;
            col.tempTotal = listSum + mayorOnly;
            col.tempListTotal = listSum; 
            grandTotalCandidate += col.tempTotal;

            let mirrorMayorSpan = document.getElementById(`mirror-mayor-${cIndex}`);
            if(mirrorMayorSpan && estimatedTotal > 0) {
                if(isPercent) {
                    let v = Math.round((mayorOnly / 100) * estimatedTotal);
                    mirrorMayorSpan.innerText = `(${v.toLocaleString()})`;
                } else {
                    let pct = (mayorOnly / estimatedTotal) * 100;
                    mirrorMayorSpan.innerText = `(${pct.toFixed(1)}%)`;
                }
            } else if(mirrorMayorSpan) {
                mirrorMayorSpan.innerText = '';
            }
        });

        let baseForPercent = isPercent ? 100 : grandTotalCandidate;
        if(baseForPercent === 0) baseForPercent = 1;

        coalitions.forEach((col, index) => {
            let el = document.getElementById(`live-total-${index}`);
            if(el) {
                let suffix = isPercent ? '%' : '';
                let percentVal = 0;
                
                if (isPercent) percentVal = col.tempTotal;
                else percentVal = (col.tempTotal / baseForPercent) * 100;
                
                let listStr = col.tempListTotal.toLocaleString();
                let totalStr = col.tempTotal.toLocaleString();
                
                el.innerHTML = `Lists: <span class="font-semibold">${listStr}${suffix}</span> ‚Ä¢ Cand. Total: <span class="font-bold">${totalStr}${suffix}</span> <span class="text-slate-400 font-normal">(${percentVal.toFixed(1)}%)</span>`;
            }
        });
    }

    function calculateResults() {
        try {
            highlightedPartyName = null; 
            textReport = "üó≥Ô∏è *ELECTION SIMULATION*\n\n";

            const totalSeats = parseInt(document.getElementById('totalSeats').value);
            const thresholdPercent = parseFloat(document.getElementById('threshold').value);
            const estimatedTotalInput = document.getElementById('estimatedTotalVotes').value;
            const estimatedTotal = parseInt(estimatedTotalInput) || 0;
            
            if(inputMode === 'percent' && estimatedTotal <= 0) { alert("Please enter Total Valid Voters."); return; }

            let grandTotalListVotes = 0; 
            let grandTotalValidVotes = 0; 
            
            let simCoalitions = JSON.parse(JSON.stringify(coalitions)); 
            
            // 1. Calculate votes
            simCoalitions.forEach(col => {
                col.listTotal = 0;
                col.parties.forEach(p => {
                    p.votes = inputMode === 'percent' ? Math.round((p.value / 100) * estimatedTotal) : Number(p.value);
                    col.listTotal += p.votes;
                });
                
                let mayorOnly = inputMode === 'percent' ? Math.round((col.mayorOnlyVotes / 100) * estimatedTotal) : Number(col.mayorOnlyVotes);
                col.totalVotes = col.listTotal + mayorOnly; 
                
                grandTotalListVotes += col.listTotal;
                grandTotalValidVotes += col.totalVotes;
            });

            // 2. Determine the GRAND TOTAL for Majority Check
            // We use the calculated grandTotalValidVotes (sum of all candidates)
            // Unless the manual input is higher (e.g. invalid votes? No, usually valid votes). 
            // In 'votes' mode, we trust the inputs. 
            // In 'percent' mode, the 'estimatedTotal' represents the 100% base.
            let baseForMajority = grandTotalValidVotes;
            if(inputMode === 'percent') baseForMajority = estimatedTotal; 
            else if(estimatedTotal > grandTotalValidVotes) baseForMajority = estimatedTotal; // Manual override if entered

            const absoluteMajority = Math.floor(baseForMajority / 2) + 1;
            
            // 3. Check for Winner using CANDIDATE TOTAL
            let firstRoundWinner = simCoalitions.find(c => c.totalVotes >= absoluteMajority);
            let winningCoalition = null;
            let isFirstRoundVictory = false;

            if (firstRoundWinner) {
                alert(`‚ö†Ô∏è FIRST ROUND VICTORY: "${firstRoundWinner.name}" exceeded 50% (${firstRoundWinner.totalVotes.toLocaleString()} votes).\n(Threshold: ${absoluteMajority.toLocaleString()})`);
                isFirstRoundVictory = true;
                winningCoalition = firstRoundWinner;
                simCoalitions.forEach(c => {
                    c.isWinner = (c.id === firstRoundWinner.id);
                    c.isApparented = false; 
                });
            } else {
                winningCoalition = simCoalitions.find(c => c.isWinner);
            }

            if(!winningCoalition) { alert("No candidate >50% and no Ballot Winner selected! Please select a winner for the runoff."); return; }

            let apparentedCoalitions = [];
            let losingCoalitions = [];

            simCoalitions.forEach(col => {
                if (col.id === winningCoalition.id) return; 
                
                if (col.isApparented && !isFirstRoundVictory) {
                    apparentedCoalitions.push(col);
                } else {
                    if(col.totalVotes > 0) losingCoalitions.push(col);
                }
            });

            // Threshold for LISTS is based on TOTAL VALID VOTES (usually)
            const thresholdVotes = baseForMajority * (thresholdPercent / 100);
            
            textReport += `üìä Total Valid Voters: ${baseForMajority.toLocaleString()}\n`;
            textReport += `üìä Total List Votes: ${grandTotalListVotes.toLocaleString()}\n`;
            textReport += `üöß List Threshold (${thresholdPercent}%): ${Math.floor(thresholdVotes)}\n`;
            
            const majoritySeats = Math.ceil(totalSeats * 0.6); 
            const minoritySeats = totalSeats - majoritySeats;

            let majorityPoolParties = [];
            winningCoalition.parties.forEach(p => {
                if(p.votes >= thresholdVotes) majorityPoolParties.push({...p, originalCoalition: winningCoalition.id});
            });
            apparentedCoalitions.forEach(acol => {
                acol.parties.forEach(p => {
                    if(p.votes >= thresholdVotes) majorityPoolParties.push({...p, originalCoalition: acol.id});
                });
            });

            let majorityResult = dHondtWithGap(majorityPoolParties, majoritySeats);

            // Opposition Groups Calculation based on CANDIDATE TOTAL votes
            let oppositionGroups = losingCoalitions.map(c => ({ 
                name: c.name, 
                votes: c.totalVotes, 
                originalObj: c, 
                isCoalition: true 
            }));
            
            let oppositionGroupResult = dHondtWithGap(oppositionGroups, minoritySeats);

            let finalOutput = [];
            let allSeatsForHemicycle = []; 

            // WINNER
            let winnerPartiesResult = majorityResult.distribution.filter(p => p.originalCoalition === winningCoalition.id);
            let winnerSeatsTotal = winnerPartiesResult.reduce((a, b) => a + b.seats, 0);
            winnerPartiesResult.forEach(p => { for(let i=0; i<p.seats; i++) allSeatsForHemicycle.push({ type: 'winner', party: p.name }); });

            finalOutput.push({
                name: winningCoalition.name, isWinner: true, isApparented: false,
                totalVotes: winningCoalition.totalVotes, // Candidate Total
                listVotes: winningCoalition.listTotal,
                mayorOnlyVotes: winningCoalition.totalVotes - winningCoalition.listTotal,
                seatsTotal: winnerSeatsTotal,
                details: winnerPartiesResult, mayorSeat: false
            });

            apparentedCoalitions.forEach(acol => {
                let acolPartiesResult = majorityResult.distribution.filter(p => p.originalCoalition === acol.id);
                let acolSeatsTotal = acolPartiesResult.reduce((a, b) => a + b.seats, 0);
                acolPartiesResult.forEach(p => { for(let i=0; i<p.seats; i++) allSeatsForHemicycle.push({ type: 'winner', party: p.name }); });

                finalOutput.push({
                    name: acol.name + " (App.)", isWinner: false, isApparented: true,
                    totalVotes: acol.totalVotes,
                    listVotes: acol.listTotal,
                    mayorOnlyVotes: acol.totalVotes - acol.listTotal,
                    seatsTotal: acolSeatsTotal,
                    details: acolPartiesResult, mayorSeat: false 
                });
            });

            oppositionGroupResult.distribution.forEach(groupSeat => {
                let coalition = groupSeat.originalObj;
                let seatsForCoalition = groupSeat.seats;
                if (seatsForCoalition > 0) {
                    allSeatsForHemicycle.push({ type: 'loser', party: "Candidate " + coalition.name }); 
                    
                    let availableForLists = seatsForCoalition - 1; // 1 Seat goes to Candidate
                    
                    let validLists = coalition.parties.filter(p => p.votes >= thresholdVotes);
                    
                    let listResult = { distribution: validLists.map(p => ({...p, seats: 0, gap: null })) };
                    
                    if (availableForLists > 0) {
                        if(validLists.length > 0) {
                            listResult = dHondtWithGap(validLists, availableForLists);
                            listResult.distribution.forEach(p => { for(let i=0; i<p.seats; i++) allSeatsForHemicycle.push({ type: 'loser', party: p.name }); });
                        } else {
                            // Simplified: Candidate keeps them as 'Candidate List'
                            for(let i=0; i<availableForLists; i++) allSeatsForHemicycle.push({ type: 'loser', party: "Candidate " + coalition.name });
                        }
                    }
                    finalOutput.push({
                        name: coalition.name, isWinner: false, isApparented: false,
                        totalVotes: coalition.totalVotes,
                        listVotes: coalition.listTotal,
                        mayorOnlyVotes: coalition.totalVotes - coalition.listTotal,
                        seatsTotal: seatsForCoalition,
                        details: listResult.distribution, mayorSeat: true
                    });
                }
            });

            finalOutput.forEach(res => {
                let icon = "üîª"; if(res.isWinner) icon = "üèÜ"; if(res.isApparented) icon = "ü§ù";
                textReport += `${icon} *${res.name.toUpperCase()}*: ${res.seatsTotal} Seats (Cand: ${res.totalVotes.toLocaleString()})\n`;
                if(res.mayorSeat) textReport += `   üë§ 1 Mayor Seat\n`;
                res.details.sort((a,b) => b.votes - a.votes);
                res.details.forEach(p => {
                    if(p.seats > 0) textReport += `   ‚úÖ ${p.name}: ${p.seats} (${p.votes.toLocaleString()})\n`;
                    else if (p.gap !== null && p.votes >= thresholdVotes) textReport += `   Need ${p.gap} votes for +1 seat\n`;
                });
                textReport += "\n";
            });

            lastCalculationResult = { seatsData: allSeatsForHemicycle, totalSeats: totalSeats };
            drawHemicycle(allSeatsForHemicycle, totalSeats);
            renderResults(finalOutput, baseForMajority, thresholdVotes);
        } catch(e) {
            console.error(e);
            alert("An error occurred during calculation. Check console for details.");
        }
    }

    function dHondtWithGap(candidates, seatsAvailable) {
        if(seatsAvailable === 0) return { distribution: candidates, cutoff: 0 };
        let distribution = candidates.map(c => ({ ...c, seats: 0, nextDivisor: 1, gap: null }));
        let quotients = [];
        distribution.forEach((cand, idx) => {
            for(let i = 1; i <= seatsAvailable; i++) quotients.push({ q: cand.votes / i, partyIdx: idx, divisor: i });
        });
        quotients.sort((a, b) => b.q - a.q);
        let lowestWinningQuotient = 0;
        for(let i = 0; i < seatsAvailable; i++) {
            let winner = quotients[i];
            distribution[winner.partyIdx].seats++;
            distribution[winner.partyIdx].nextDivisor = winner.divisor + 1;
            lowestWinningQuotient = winner.q;
        }
        distribution.forEach(cand => {
            let nextPotentialQ = cand.votes / cand.nextDivisor;
            if (nextPotentialQ < lowestWinningQuotient) {
                let votesNeeded = Math.ceil((lowestWinningQuotient * cand.nextDivisor) - cand.votes) + 1;
                cand.gap = votesNeeded > 0 ? votesNeeded : 1;
            } else { cand.gap = null; }
        });
        return { distribution: distribution, cutoff: lowestWinningQuotient };
    }

    function setHighlight(partyName) {
        if (highlightedPartyName === partyName) highlightedPartyName = null;
        else highlightedPartyName = partyName;
        if(lastCalculationResult) drawHemicycle(lastCalculationResult.seatsData, lastCalculationResult.totalSeats);
        
        if(lastCalculationResult && lastCalculationResult.output) {
             
        }
    }

    function drawHemicycle(seatsData, totalSeats) {
        const svg = document.getElementById('hemicycleSvg');
        svg.innerHTML = ''; 
        const majoritySeats = seatsData.filter(s => s.type === 'winner');
        const oppositionSeats = seatsData.filter(s => s.type !== 'winner');
        const totalMajority = majoritySeats.length;
        const totalOpposition = oppositionSeats.length;
        let drawnMajIndex = 0;
        let drawnOppIndex = 0;
        const centerX = 300; const centerY = 240; const maxRadius = 190; const rowGap = 35;
        let numRows = totalSeats > 70 ? 4 : (totalSeats > 40 ? 3 : (totalSeats < 15 ? 1 : 2));
        let rowRadii = []; let totalArcLength = 0;
        let startRadius = maxRadius - ((numRows - 1) * rowGap);
        for(let i=0; i<numRows; i++) { let r = startRadius + (i * rowGap); rowRadii.push(r); totalArcLength += r; }
        let seatsPerRow = []; let seatsAssigned = 0;
        for(let i=0; i<numRows; i++) {
            if (i === numRows - 1) seatsPerRow.push(totalSeats - seatsAssigned);
            else { let count = Math.round(totalSeats * (rowRadii[i] / totalArcLength)); seatsPerRow.push(count); seatsAssigned += count; }
        }
        for (let r = numRows - 1; r >= 0; r--) {
            let radius = rowRadii[r];
            let rowCapacity = seatsPerRow[r];
            let majInThisRow = Math.round(rowCapacity * (totalMajority / totalSeats));
            if (majInThisRow > (totalMajority - drawnMajIndex)) majInThisRow = totalMajority - drawnMajIndex;
            if (r === 0 && (totalMajority - drawnMajIndex) > 0) majInThisRow = totalMajority - drawnMajIndex; 
            let oppInThisRow = rowCapacity - majInThisRow;
            if (oppInThisRow > (totalOpposition - drawnOppIndex)) oppInThisRow = totalOpposition - drawnOppIndex;
            let rowData = [];
            rowData.push(...majoritySeats.slice(drawnMajIndex, drawnMajIndex + majInThisRow));
            rowData.push(...oppositionSeats.slice(drawnOppIndex, drawnOppIndex + oppInThisRow));
            drawnMajIndex += majInThisRow; drawnOppIndex += oppInThisRow;
            let startAngle = Math.PI * 0.95; let endAngle = Math.PI * 0.05;
            let angleStep = rowCapacity > 1 ? (startAngle - endAngle) / (rowCapacity - 1) : 0;
            for (let s = 0; s < rowData.length; s++) {
                let angle = rowCapacity === 1 ? Math.PI / 2 : startAngle - (s * angleStep);
                let x = centerX + radius * Math.cos(angle);
                let y = centerY - radius * Math.sin(angle);
                let seatInfo = rowData[s] || { type: 'empty', party: 'N/A' };
                let finalColor;
                if (highlightedPartyName && seatInfo.party === highlightedPartyName) finalColor = '#facc15'; 
                else {
                    finalColor = (seatInfo.type === 'winner') ? '#10b981' : '#ef4444';
                    if(seatInfo.party && seatInfo.party.includes("Candidate") && !highlightedPartyName) finalColor = '#b91c1c';
                }
                let circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", x); circle.setAttribute("cy", y); circle.setAttribute("r", 7);
                circle.setAttribute("fill", finalColor);
                circle.setAttribute("stroke", "white"); circle.setAttribute("stroke-width", "1");
                circle.classList.add("hemicycle-dot");
                let title = document.createElementNS("http://www.w3.org/2000/svg", "title");
                title.textContent = seatInfo.party;
                circle.appendChild(title);
                svg.appendChild(circle);
            }
        }
    }

    function updateParty(cIndex, pIndex, field, value) { if(field === 'name') coalitions[cIndex].parties[pIndex].name = value; }
    function updatePartyValue(cIndex, pIndex, value) { coalitions[cIndex].parties[pIndex].value = value; recalcLiveTotals(); }
    function updateCoalitionName(cIndex, value) { coalitions[cIndex].name = value; }
    function updateMayorOnlyVotes(cIndex, value) { coalitions[cIndex].mayorOnlyVotes = value; recalcLiveTotals(); }
    function addParty(cIndex) { coalitions[cIndex].parties.push({ name: "List " + (coalitions[cIndex].parties.length + 1), value: 0 }); renderCoalitions(); }
    function removeParty(cIndex, pIndex) { coalitions[cIndex].parties.splice(pIndex, 1); renderCoalitions(); }
    function addCoalition() { coalitions.push({ id: Date.now(), name: "Coalition " + (coalitions.length + 1), isWinner: false, isApparented: false, mayorOnlyVotes: 0, parties: [{ name: "List 1", value: 0 }] }); renderCoalitions(); }
    function removeCoalition(index) { if(confirm("Delete this coalition?")) { coalitions.splice(index, 1); renderCoalitions(); }}
    function setWinner(index) { coalitions.forEach((c, i) => { c.isWinner = (i === index); if(c.isWinner) c.isApparented = false; }); renderCoalitions(); }
    function setApparented(index, isChecked) { coalitions[index].isApparented = isChecked; if(isChecked) coalitions[index].isWinner = false; renderCoalitions(); }
    function loadScenario(type) {
        if(type === 'Pisa2023') {
            if(inputMode === 'percent') {
                 coalitions = [
                    { id: 1, name: "Michele Conti (Centrodestra)", isWinner: true, isApparented: false, mayorOnlyVotes: 3.0, parties: [
                        { name: "Fratelli d'Italia", value: 16.9 }, { name: "Michele Conti Sindaco", value: 14.7 }, 
                        { name: "Lega", value: 10.4 }, { name: "Pesciatini per Pisa", value: 4.8 }, 
                        { name: "Forza Italia - UDC - PLI", value: 3.5 }, { name: "Pisa Punto Zero", value: 1.0 }
                    ]},
                    { id: 2, name: "Paolo Martinelli (Centrosinistra)", isWinner: false, isApparented: false, mayorOnlyVotes: 3.1, parties: [
                        { name: "Partito Democratico", value: 23.9 }, { name: "La Citt√† delle Persone", value: 5.6 }, 
                        { name: "Sinistra Unita per Pisa", value: 4.9 }, { name: "Movimento 5 Stelle", value: 3.0 },
                        { name: "Riformisti per Pisa", value: 2.2 }
                    ]},
                    { id: 3, name: "Ciccio Auletta (Sinistra)", isWinner: false, isApparented: false, mayorOnlyVotes: 0.1, parties: [
                        { name: "Una citt√† in comune", value: 5.1 }, { name: "Unione Popolare", value: 1.4 }
                    ]},
                     { id: 4, name: "Altri Candidati", isWinner: false, isApparented: false, mayorOnlyVotes: 0.2, parties: [
                        { name: "Rita Mariotti (Terzo Polo)", value: 1.3 }, { name: "Alexandre Dei (Patto Civico)", value: 0.6 },
                        { name: "Edoardo Polacco (Comitato Libert√† Toscana)", value: 0.5 }
                    ]}
                ];
                document.getElementById('estimatedTotalVotes').value = 40500;
            } else {
                 coalitions = [
                    { id: 1, name: "Michele Conti (Centrodestra)", isWinner: true, isApparented: false, mayorOnlyVotes: 1229, parties: [
                        { name: "Fratelli d'Italia", value: 6415 }, { name: "Michele Conti Sindaco", value: 5470 }, 
                        { name: "Lega", value: 3889 }, { name: "Pesciatini per Pisa", value: 1677 }, 
                        { name: "Forza Italia - UDC - PLI", value: 1126 }, { name: "Pisa Punto Zero", value: 285 }
                    ]},
                    { id: 2, name: "Paolo Martinelli (Centrosinistra)", isWinner: false, isApparented: false, mayorOnlyVotes: 1274, parties: [
                        { name: "Partito Democratico", value: 8847 }, { name: "La Citt√† delle Persone", value: 2532 }, 
                        { name: "Sinistra Unita per Pisa", value: 1902 }, { name: "Movimento 5 Stelle", value: 1146 },
                        { name: "Riformisti per Pisa", value: 833 }
                    ]},
                    { id: 3, name: "Ciccio Auletta (Sinistra)", isWinner: false, isApparented: false, mayorOnlyVotes: 9, parties: [
                        { name: "Una citt√† in comune", value: 1991 }, { name: "Unione Popolare", value: 706 }
                    ]},
                     { id: 4, name: "Altri Candidati", isWinner: false, isApparented: false, mayorOnlyVotes: 22, parties: [
                        { name: "Rita Mariotti (Terzo Polo)", value: 508 }, { name: "Alexandre Dei (Patto Civico)", value: 246 },
                        { name: "Edoardo Polacco (Comitato Libert√† Toscana)", value: 77 }
                    ]}
                ];
                document.getElementById('estimatedTotalVotes').value = 40211;
            }
            renderCoalitions();
        }
    }
    function copyToClipboard() { if(!textReport) return; navigator.clipboard.writeText(textReport).then(()=>alert("Copied to clipboard!")); }

    init();
</script>
</body>
</html>
